<link rel="import" href="../utility/completion-status-mixin.html">
<link rel="import" href="d2l-completion-status.html">
<link rel="import" href="d2l-completion-requirement.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-icons/d2l-icon.html">

<dom-module id="d2l-activity-link">
	<template>
		<style>
			:host {
				display: block;
				color: var(--d2l-color-ferrite);
			}

			#activityLink {
				display: table;
				table-layout: fixed;
				width: 100%;
			}

			#activityTitle {
				@apply --d2l-body-compact-text;

				overflow: hidden;
				text-overflow: ellipsis;
				float: left;
				display: table-cell;
				width: 100%;
			}

			#activityTitle.exempt, #activityTitle.optional {
				white-space: nowrap;
			}

			#activityTitle.required {
				display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2; /* number of lines to show */
				line-height: 24px; /* fallback */
				max-height: 48px; /* fallback */
			}

			d2l-completion-requirement {
				float: left;
				display: table-cell;
				width: 87%;
				line-height: 24px;
			}

			.launch-page d2l-completion-requirement {
				padding-left: 32px;
			}

			d2l-completion-status {
				text-align: right;
				display: table-cell;
				width: 13%;
				vertical-align: middle;
				line-height: 24px;
				color: var(--d2l-color-olivine);
			}

			.launch-page d2l-completion-status {
				color: var(--d2l-color-celestine);
			}

			.activity-icon {
				margin-right: 10px;
			}

		</style>
		<div id="activityLink" class$="[[_getLaunchPageClass(launchPage)]]">
			<a id="activityTitle" on-click="setCurrent" class$="[[completionRequirement]]">
				<template is="dom-if" if="[[launchPage]]">
					<d2l-icon icon$="[[_getActivityIcon(entity)]]" class="activity-icon"></d2l-icon>
				</template>
				[[entity.properties.title]]
			</a>
			<template is="dom-if" if="[[showCompletionRequirement]]">
				<d2l-completion-requirement
					href="[[href]]"
					token="[[token]]">
				</d2l-completion-requirement>
			</template>
			<d2l-completion-status
				href="[[href]]"
				token="[[token]]"
				class$=[[completionRequirement]]>
			</d2l-completion-status>
		</div>
		</template>

	</template>
	<script>
		/*
		@memberOf window.D2L.Polymer.Mixins;
		@mixes D2L.Polymer.Mixins.CompletionStatusMixin
		*/
		class D2LActivityLink extends D2L.Polymer.Mixins.CompletionStatusMixin() {
			static get is() {
				return 'd2l-activity-link';
			}
			static get properties() {
				return {
					currentActivity: {
						type: String,
						value: '',
						notify: true
					},
					completionRequirement: {
						type: String,
						computed: '_getCompletionRequirement(entity)',
						observer: '_showCompletionRequirement'
					},
					showCompletionRequirement: {
						type: Boolean,
						value: false
					},
					launchPage: {
						type: Boolean,
						value: false
					}
				};
			}
			static get observers() {
				return [
					'onCurrentActivityChanged(currentActivity, entity)'
				];
			}

			static get fileActivity() {
				return 'file-activity';
			}

			static get linkActivity() {
				return 'link-activity';
			}

			static get contentClass() {
				return 'link-content-service';
			}

			static get mimeType() {
				return new Map([
					['application/pdf', 'd2l-tier1:file-video'],
					['image/bmp', 'd2l-tier1:file-image'],
					['image/gif', 'd2l-tier1:file-image'],
					['image/jpeg', 'd2l-tier1:file-image'],
					['image/png', 'd2l-tier1:file-image'],
					['image/svg+xml', 'd2l-tier1:file-image'],
					['text/html', 'd2l-tier1:file-document']
				]);
			}

			ready() {
				super.ready();
				this.addEventListener('keypress', this._onKeyPress);
			}

			_onKeyPress(event) {
				if ( event.key !== 'Enter' ) {
					return;
				}
				this.setCurrent();
			}

			setCurrent() {
				this.currentActivity = this.entity && this.entity.getLinkByRel('self').href;
			}

			onCurrentActivityChanged( currentActivity, entity ) {
				if ( currentActivity && entity ) {
					var current = entity.getLinkByRel('self').href === currentActivity;
					if ( current ) {
						this.$.activityLink.classList.add('current');
					} else {
						this.$.activityLink.classList.remove('current');
					}
					this.dispatchEvent( new CustomEvent('activitySelected', { detail:{ activityHref: currentActivity }, composed: true } ) );
				}
			}

			_showCompletionRequirement( exemption ) {
				switch ( exemption ) {
					case 'exempt':
					case 'optional':
						this.showCompletionRequirement = true;
						break;
				}
			}

			_getLaunchPageClass(launchPage) {
				return launchPage ? 'launch-page' : '';
			}

			_getActivityIcon(entity) {
				if (!entity || !entity.entities) {
					return 'd2l-tier1:help';
				}
				for (let i = 0; i < entity.entities.length; i++) {
					const subEntity = entity.entities[i];
					// hypermedia classes tend to be more specific at the end of the array
					for (let j = subEntity.class.length - 1; j >= 0; --j) {
						switch (subEntity.class[j]) {
							case D2LActivityLink.fileActivity:
								return this._getFileEntityType(subEntity);
							case D2LActivityLink.linkActivity:
								return this._getLinkEntityType(subEntity);
							case D2LActivityLink.contentClass:
								return 'd2l-tier1:table-of-contents';
						}
					}
				}
				return 'd2l-tier1:help';
			}

			_getFileEntityType(fileActivity) {
				const file = fileActivity.getSubEntityByClass('file');
				const mimeType = file && file.properties && file.properties.type;
				return D2LActivityLink.mimeType.get(mimeType) || 'd2l-tier1:help';
			}

			_getLinkEntityType(linkActivity) {
				const link = linkActivity.getLinkByRel('about');
				if (link && link.href.startsWith('https://')) {
					return 'd2l-tier1:link';
				}
				return 'd2l-tier1:new-window';
			}
		}
		customElements.define(D2LActivityLink.is, D2LActivityLink);
	</script>
</dom-module>
