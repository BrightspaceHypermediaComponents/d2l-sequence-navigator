<link rel="import" href="d2l-activity-link.html">
<link rel="import" href="../utility/completion-status-mixin.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-icons/d2l-icons.html">
<link rel="import" href="../../d2l-offscreen/d2l-offscreen.html">

<dom-module id="d2l-inner-module">
	<template>
		<style>
			:host {
				display: block;
				cursor: pointer;
				@apply --d2l-body-compact-text;
				width: 100%;
				--d2l-inner-module-background-color: transparent;
			}

			:host > div {
				margin-top: 10px;
				margin-bottom: 10px;
				border-radius: 8px;
				background-color: var(--d2l-color-sylvite);
				box-shadow: 0px 0px 0px 10px white;
			}

			#header-container:focus-within,
			#header-container:focus,
			#header-container:hover {
				--d2l-inner-module-background-color: var(--d2l-asv-hover-color);
				--d2l-inner-module-border-color: var(--d2l-asv-border-color);
			}

			.d2l-asv-current {
				--d2l-inner-module-background-color: var(--d2l-asv-primary-color);
				--d2l-inner-module-text-color: var(--d2l-asv-selected-text-color);
				--d2l-inner-module-border-color: var(--d2l-asv-border-color);
			}

			#header-container {
				--d2l-inner-module-border-color: var(--d2l-inner-module-background-color);
				padding: 12px 0px;
				border-radius: 8px;
			}

			#module-header {
				display: flex;
				padding: 0px 20px;
				background-color: var(--d2l-inner-module-background-color);
				border: 2px solid var(--d2l-inner-module-border-color);
			}

			#module-header > a{
				text-decoration: none;
				color: var(--d2l-inner-module-text-color);
				outline: none;
			}

			.module-title {	
				@apply --d2l-body-small-text;
				color: var(--d2l-inner-module-text-color);

				width: 100%;
				overflow: hidden;
				text-overflow: ellipsis;
				float: left;
				display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2; /* number of lines to show */
				max-height: 2.0rem; /* fallback */
			}

			ol {
				list-style-type: none;
				border-collapse: collapse;
				margin: 0px;
				padding: 0px;
			}

			d2l-activity-link {
				@apply --d2l-body-compact-text;
				width: calc(100% - 20px);
			}


		</style>

		<div>
			<div id="header-container">
				<div id="module-header" class$="[[_getIsSelected(currentActivity, entity)]]" on-click="_onHeaderClicked">
					<a on-click="_onHeaderClicked" href="javascript:void(0)">
						<span class="module-title">[[entity.properties.title]]</span>
					</a>
				</div>
			</div>

			<ol>
				<template is="dom-repeat" items="[[subEntities]]" as="childLink">
					<li>
						<d2l-activity-link
							href="[[childLink.href]]"
							token="[[token]]"
							current-activity="{{currentActivity}}"
							on-sequencenavigator-d2l-activity-link-current-activity="childIsActiveEvent"
						></d2l-activity-link>
					</li>
				</template>
			</ol>
		</div>
	</template>

	<script>
		/*
		@memberOf window.D2L.Polymer.Mixins;
		@mixes D2L.Polymer.Mixins.CompletionStatusMixin
		*/
		class D2LInnerModule extends D2L.Polymer.Mixins.CompletionStatusMixin() {
			static get is() {
				return 'd2l-inner-module';
			}
			static get properties() {
				return {
					currentActivity: {
						type: String,
						value: '',
						notify: true
					},
					hasCurrentActivity: {
						type: Boolean,
						value: false
					},
					subEntities: {
						type: Array,
						computed: 'getSubEntities(entity)'
					}
				};
			}

			getSubEntities(entity) {
				return entity && entity.getSubEntities()
					.filter( subEntity => (subEntity.hasClass('sequenced-activity') && subEntity.hasClass('available')) || ( subEntity.href && subEntity.hasClass('sequence-description') ) )
					.map(this._getHref);
			}

			_getHref(entity) {
				return entity && entity.getLinkByRel && entity.getLinkByRel('self') || entity || '';
			}

			_getIsSelected(currentActivity, entity) {
				const selected = entity && entity.getLinkByRel('self').href === currentActivity;
				if (selected) {
					this.dispatchEvent(new CustomEvent('sequencenavigator-d2l-inner-module-current-activity', {detail: { href: this.href}}));
				}
				return (selected) ? 'd2l-asv-current' : '';
			}

			_onHeaderClicked() {
				this.currentActivity = this.entity.getLinkByRel('self').href;
			}

			childIsActiveEvent() {
				this.dispatchEvent(new CustomEvent('sequencenavigator-d2l-inner-module-current-activity', {detail: { href: this.href}}));
			}

		}
		customElements.define(D2LInnerModule.is, D2LInnerModule);

	</script>
</dom-module>