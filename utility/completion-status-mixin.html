<link rel="import" href="../../polymer-siren-mixins/siren-entity-mixin.html">

<script>
(function() {
	/*
		@polymerMixin
		@mixes SirenEntityMixin
		@memberOf D2L.Polymer.Mixins;
	*/
	D2L.Polymer.Mixins.CompletionStatusMixin = function(superClass) {
		return class extends window.D2L.Polymer.Mixins.SirenEntityMixin(superClass) {

			static get properties() {
				return {
					completionCount: {
						type: Object,
						computed: '_getStatus(entity)',
						observer: '_getPercentCompleted'
					},
					percentCompleted: {
						type: Number,
						value: 0
					},
					completionCompleted: {
						type: String,
						value: '',
						computed: '_stringifyCount(completionCount.completed)'
					},
					completionTotal: {
						type: String,
						value: '',
						computed: '_stringifyCount(completionCount.total)'
					}
				};
			}

			_getStatus(entity) {
				const completionEntity = entity.getSubEntityByClass('completion');
				if ( !completionEntity || !completionEntity.properties) {
					return {
						completed: 0,
						optionalViewed: 0,
						optionalTotal: 0,
						total: 0
					};
				}
				return completionEntity.properties;
			}

			_getPercentCompleted() {
				if (!this.completionCount || this.completionCount.total === 0) return 0;
				this.percentCompleted = 100 * this.completionCount.completed / this.completionCount.total;
			}

			_stringifyCount(count) {
				if ( count === undefined ||  count === null ) {
					return '';
				}
				return `${count}`;
			}

			_getCompletionRequirement(activity) {
				var itemSubEntity = activity.getSubEntityByRel('item');
				var aboutSubEntity =  activity.getSubEntityByRel('about');
				if (itemSubEntity
					&& itemSubEntity.getSubEntityByClass('exemption')
					&& itemSubEntity.getSubEntityByClass('exemption').hasClass('exempted')) {
					return 'exempt';
				}
				if (aboutSubEntity
					&& aboutSubEntity.getSubEntityByClass('exemption')
					&& aboutSubEntity.getSubEntityByClass('exemption').hasClass('exempted')) {
					return 'exempt';
				}
				if (aboutSubEntity && !aboutSubEntity.getSubEntityByClass('completion')) {
					return 'optional';
				}
				else return 'required';
			}

			_getCompletionStatus(activity) {
				var aboutSubEntity =  activity.getSubEntityByRel('about');
				if (aboutSubEntity && aboutSubEntity.getSubEntityByClass('completion')) {
					if (aboutSubEntity.getSubEntityByClass('completion').hasClass('completed')) {
						return 'complete';
					} else {
						return 'incomplete';
					}
				} else {
					if (aboutSubEntity.getSubEntityByClass('last-viewed') ) {
						return 'optional-viewed';
					}
					return 'optional';
				}
			}
		};
	};
	window.D2L = window.D2L || {};
	window.D2L.Polymer = window.D2L.Polymer || {};
	window.D2L.Polymer.Mixins = window.D2L.Polymer.Mixins || {};
	window.D2L.Polymer.Mixins.CompletionStatusMixin = D2L.Polymer.Mixins.CompletionStatusMixin;
})();
</script>
