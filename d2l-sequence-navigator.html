<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-polymer-siren-behaviors/store/entity-behavior.html">
<link rel="import" href="./components/d2l-outer-module.html">
<link rel="import" href="../d2l-accordion/d2l-accordion.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../siren-entity/siren-entity.html">
<link rel="import" href="./localize-behavior.html">
<link rel="import" href="./d2l-sequence-navigator-styles.html">
<!--
'd2l-sequence-navigator'


@demo demo/index.html
-->

<dom-module id="d2l-sequence-navigator">
	<template>
		<style>
		:host {
			display: block;
			height: 100%;
			border-right: 1px solid var(--d2l-color-mica);
			background-color: white;
		}

		.module-item-list {
			list-style-type: none;
			padding: 0px;
			margin: 0px;
		}

		::slotted(.shadowed) {
			position: relative;
			z-index: 1;
			box-shadow: 0 4px 0 0 rgba(185,194,208,.3);
		}

		.module-content {
			height: calc( 100% - 259px );
			overflow-y: scroll;
		}
		
		.current {
			--d2l-lesson-header-background-color: var(--d2l-asv-primary-color);
			--d2l-lesson-header-text-color: var(--d2l-asv-selected-text-color);
			outline: 1px solid var(--d2l-border-color);
		}

		
		d2l-activity-link:focus {
			outline: none;
		}

		d2l-activity-link {
			@apply --d2l-body-compact-text;

			width: calc(100% - 20px);
		}

		d2l-activity-link.current {
			background-color: var(--d2l-asv-selected-color);
		}

		d2l-activity-link:hover:not(.current),
		.header-container:hover {
			background-color: var(--d2l-asv-hover-color);
		}

		</style>
		<siren-entity href="[[rootHref]]" token="[[token]]" entity="{{_lessonEntity}}"></siren-entity>
		<slot name="lesson-header"></slot>
		<d2l-accordion auto-close class="module-content" id="sidebarContent" on-scroll="onSidebarScroll">

			<ol class="module-item-list">
				<template is="dom-repeat" items="[[subEntities]]" as="childLink">
					<li>
						<template is="dom-if" if="[[!_isActivity(childLink)]]">
							<d2l-outer-module
								href="[[childLink.href]]"
								token="[[token]]"
								current-activity="{{href}}"
								selected-module="{{selectedModule}}"
							></d2l-outer-module>
						</template>						
						<template is="dom-if" if="[[_isActivity(childLink)]]">
							<d2l-activity-link class$="[[_getIsCurrent(childLink, currentActivity)]]"
								href="[[childLink.href]]"
								token="[[token]]"
								current-activity="{{href}}"
								tabindex="0"
							></d2l-activity-link>
						</template>
					</li>
				</template>
			</ol>
			<slot name="end-of-lesson"></slot>
		</d2l-accordion>
	</template>
	<script>
		/*
		@memberOf D2L.Polymer.Mixins;
		@mixes SirenEntityMixin
		*/
		class D2LSequenceNavigator extends Polymer.mixinBehaviors([
			D2L.PolymerBehaviors.Siren.EntityBehavior,
			D2L.PolymerBehaviors.SequenceNavigator.LocalizeBehavior
		],
		Polymer.Element
		) {
			static get is() {
				return 'd2l-sequence-navigator';
			}
			static get properties() {
				return {
					href: {
						type: String,
						reflectToAttribute: true,
						notify: true
					},
					selectedModule: {
						type: String,
						value: ''
					},
					rootHref: {
						type: String,
						computed: '_getRootHref(entity)'
					},
					subEntities: {
						type: Array,
						computed: 'getSubEntities(_lessonEntity)'
					},
					_lessonEntity:{
						type: Object
					},
					sidebarContent: {
						type: Object,
						computed: 'getSideBarContent()'
					}
				};
			}
			ready() {
				super.ready();
				const styles = JSON.parse(document.getElementsByTagName('html')[0].getAttribute('data-asv-css-vars'));
				this.updateStyles(
					styles
				);
			}

			_getRootHref(entity) {
				const rootLink = entity && entity.getLinkByRel('https://sequences.api.brightspace.com/rels/sequence-root');
				return rootLink && rootLink.href || '';
			}

			getSubEntities(entity) {
				return entity && entity.getSubEntities()
					.filter( subEntity =>
						(subEntity.properties && Object.keys(subEntity.properties).length > 0) || subEntity.href )
					.map(this._getHref);
			}

			_isActivity( link ) {
				return link && link.hasClass('sequenced-activity');
			}

			_getHref(entity) {
				return entity && entity.getLinkByRel && entity.getLinkByRel('self') || entity || '';
			}

			_getIsCurrent(childLink, currentActivity) {
				if ( childLink.href === currentActivity ) {
					this.shadowRoot.querySelector('d2l-accordion-collapse').setAttribute('opened', '');
					this.hasCurrentActivity = true;
					return 'current';
				}
				this.hasCurrentActivity = false;
			}

			onSidebarScroll() {
				const sidebarHeader = this.getSideBarHeader();
				if ( this.$.sidebarContent.scrollTop === 0 ) {
					if ( sidebarHeader.classList.contains('shadowed') ) {
						sidebarHeader.classList.remove('shadowed');
					}
				} else {
					if ( !sidebarHeader.classList.contains('shadowed') ) {
						sidebarHeader.classList.add('shadowed');
					}
				}
			}

			getSideBarHeader() {
				const sidebarHeaderSlot = this.shadowRoot.querySelector('slot');
				const sidebarHeader = sidebarHeaderSlot.assignedNodes()[0].querySelector('d2l-lesson-header#sidebarHeader');
				return sidebarHeader;
			}
		}

		window.customElements.define(D2LSequenceNavigator.is, D2LSequenceNavigator);
	</script>
</dom-module>