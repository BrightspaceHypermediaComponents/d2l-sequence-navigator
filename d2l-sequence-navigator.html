<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../d2l-polymer-siren-behaviors/store/entity-behavior.html">
<link rel="import" href="./components/d2l-sequence-navigator-item.html">
<link rel="import" href="./components/d2l-lesson-header.html">
<link rel="import" href="../d2l-accordion/d2l-accordion.html">
<link rel="import" href="../d2l-colors/d2l-colors.html">
<link rel="import" href="../siren-entity/siren-entity.html">
<link rel="import" href="./localize-behavior.html">
<!--
'd2l-sequence-navigator'


@demo demo/index.html
-->

<dom-module id="d2l-sequence-navigator">
	<template>
		<style>
		:host {
			display: block;
			height: 100%;
			background-color: var(--d2l-color-regolith);
		}

		d2l-sequence-navigator-item {
			width: 100% - 15px;
			margin-top: 15px;
		}

		.module-item-list {
			list-style-type: none;
			padding-left: 30px;
			padding-right: 30px;
			margin-top: 0px;
			margin-bottom: 0px;
		}

		.end-of-lesson {
			color: var(--d2l-color-celestine);
			text-decoration: none;
			cursor: pointer;
			@apply --d2l-label-text;
		}

		.end-of-lesson-holder {
			padding-left: 35px;
			padding-top: 30px;
		}

		.module-header {
			padding-top: 40px;
			padding-left: 30px;
			padding-right: 30px;
			height: 120px;
			position: relative;
			z-index: 1;
		}

		.shadowed {
			box-shadow: 0 4px 0 0 rgba(185,194,208,.3);
		}

		.module-content {
			height: calc( 100% - 120px - 40px );
			overflow-y: auto;
			padding-bottom: 40px;
		}

		</style>
		<siren-entity href="[[_moduleHref]]" token="[[token]]" entity="{{_moduleEntity}}"></siren-entity>
		<siren-entity href="[[_rootHref]]" token="[[token]]" entity="{{_lessonEntity}}"></siren-entity>
		<template is="dom-if" if="[[!launchPage]]">
			<d2l-lesson-header class="module-header" id="sidebarHeader"
				href="[[_rootHref]]"
				token="[[token]]"
				entity="{{_lessonEntity}}"
				tabindex="0"
			></d2l-lesson-header>
		</template>
		<d2l-accordion auto-close="[[!launchPage]]" class="module-content" id="sidebarContent" on-scroll="onSidebarScroll">

			<ol class="module-item-list">
				<template is="dom-repeat" items="[[subEntities]]" as="childLink">
					<li>
						<d2l-sequence-navigator-item
							href="[[childLink.href]]"
							token="[[token]]"
							current-activity="{{href}}"
							selected-module="{{selected-module}}"
							is-lesson-child
							launch-page="[[launchPage]]"
						>
						</d2l-sequence-navigator-item>
					</li>
				</template>
			</ol>

			<template is="dom-if" if="[[!launchPage]]">
				<div class="end-of-lesson-holder">
					<a on-click="showEndOfLesson" class="end-of-lesson">[[localize('endOfLesson')]]</a>
				</div>
			</template>
		</d2l-accordion>
	</template>
	<script>
		/*
		@memberOf D2L.Polymer.Mixins;
		@mixes SirenEntityMixin
		*/
		class D2LSequenceNavigator extends Polymer.mixinBehaviors([
			D2L.PolymerBehaviors.Siren.EntityBehavior,
			D2L.PolymerBehaviors.SequenceNavigator.LocalizeBehavior
		],
		Polymer.Element
		) {
			static get is() {
				return 'd2l-sequence-navigator';
			}
			static get properties() {
				return {
					href: {
						type: String,
						reflectToAttribute: true,
						notify: true
					},
					selectedModule: {
						type: String,
						value: ''
					},
					_rootHref: {
						type: String,
						computed: '_getDirectParentHref(_moduleEntity)'
					},
					subEntities: {
						type: Array,
						computed: 'getSubEntities(_lessonEntity)'
					},
					_moduleEntity: {
						type: Object
					},
					_moduleHref: {
						type: String,
						computed: '_getModuleHref(entity)'
					},
					_lessonEntity:{
						type: Object
					},
					launchPage: {
						type: Boolean,
						value: false
					}
				};
			}

			connectedCallback() {
				super.connectedCallback();
			}

			_getModuleHref(entity) {
				if (entity && entity.hasClass('sequence-description') ) {
					var selfLink = entity.getLinkByRel('self');
					return selfLink && selfLink.href || '';
				}
				return entity && entity.hasClass('sequenced-activity') && this._getDirectParentHref( entity ) || '';
			}

			_getDirectParentHref(entity) {
				const upLink = entity && entity.getLinkByRel('up');
				return upLink && upLink.href || '';
			}

			getSubEntities(entity) {
				return entity && entity.getSubEntities()
					.filter( subEntity =>
						(subEntity.properties && Object.keys(subEntity.properties).length > 0) || subEntity.href )
					.map(this._getHref);
			}

			_getHref(entity) {
				return entity && entity.getLinkByRel && entity.getLinkByRel('self') || entity || '';
			}

			showEndOfLesson() {
				this.href = this._rootHref + '/end-of-sequence';
			}

			onSidebarScroll() {
				if ( this.$.sidebarContent.scrollTop === 0 ) {
					if ( this.$.sidebarHeader.classList.contains('shadowed') ) {
						this.$.sidebarHeader.classList.remove('shadowed');
					}
				} else {
					if ( !this.$.sidebarHeader.classList.contains('shadowed') ) {
						this.$.sidebarHeader.classList.add('shadowed');
					}
				}
			}
		}

		window.customElements.define(D2LSequenceNavigator.is, D2LSequenceNavigator);
	</script>
</dom-module>
